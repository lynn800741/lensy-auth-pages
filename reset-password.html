<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self' https://bqhkqpnmnescvkhyjown.supabase.co">
    <title>LENSY - 重設密碼</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #F6E8DF;
        }
        .container {
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 20px;
        }
        .logo {
            font-size: 48px;
            font-weight: bold;
            color: #FEAE96;
            margin-bottom: 20px;
        }
        .icon {
            font-size: 50px;
            margin: 0 auto 30px;
            width: 100px;
            height: 100px;
            border: 4px solid #D4886A;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #D4886A;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .message {
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        .form-container {
            background-color: #f5f5f5;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="password"]:focus {
            outline: none;
            border-color: #D4886A;
        }
        .password-requirements {
            font-size: 14px;
            color: #666;
            text-align: left;
            margin-top: 8px;
        }
        .button {
            background-color: #D4886A;
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #B97356;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
        }
        .success {
            color: #4CAF50;
            font-size: 14px;
            margin-top: 10px;
        }
        .loading {
            display: none;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">LENSY</div>
        <div class="icon">🔒</div>
        <h1>重設密碼</h1>
        <p class="message">
            請輸入您的新密碼。<br>
            密碼至少需要 8 個字符，並包含字母和數字。
        </p>
        
        <div class="form-container">
            <form id="resetForm">
                <div class="form-group">
                    <label for="password">新密碼</label>
                    <input type="password" id="password" name="password" required placeholder="輸入新密碼">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">確認新密碼</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="再次輸入新密碼">
                </div>
                
                <div class="password-requirements">
                    • 至少 8 個字符<br>
                    • 必須包含字母和數字
                </div>
                
                <button type="submit" class="button" id="submitBtn">重設密碼</button>
            </form>
            
            <div id="loading" class="loading">正在處理...</div>
            <div id="error" class="error"></div>
            <div id="success" class="success"></div>
        </div>
    </div>

    <!-- 引入 Supabase JavaScript 客戶端 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // 初始化 Supabase 客戶端
        const { createClient } = supabase;
        
        // 使用更新的 API key
        const SUPABASE_URL = 'https://bqhkqpnmnescvkhyjown.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxaGtxcG5tbmVzY3ZraHlqb3duIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTM2MjYsImV4cCI6MjA2ODcyOTYyNn0.rJ5wsgV9_t0Z99lGY9JcWBrHAagjlVJl-GOT2htFb1s';
        
        console.log('Supabase URL:', SUPABASE_URL);
        console.log('Supabase Key (前20字元):', SUPABASE_ANON_KEY.substring(0, 20) + '...');
        
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 包裝初始化邏輯在 async 函數中
        (async function init() {
        
        // 調試點 1: 檢查初始 URL
        console.warn('🔍 調試點 1: 頁面載入時的 URL');
        console.log('完整 URL:', window.location.href);
        console.log('Hash:', window.location.hash);
        console.log('Search:', window.location.search);
        
        // 先嘗試使用 Supabase 的內建方法處理 URL
        try {
            console.warn('🔍 調試點 2: 嘗試 getSessionFromUrl');
            const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSessionFromUrl({ storeSession: true });
            
            console.log('getSessionFromUrl 結果:', { sessionData, sessionError });
            
            if (sessionData?.session) {
                console.warn('✅ 調試點 3: 成功獲取 session');
                console.log('Session 內容:', sessionData.session);
                // 顯示重設密碼表單
                document.getElementById('error').textContent = '';
                document.getElementById('resetForm').style.display = 'block';
                window.hasValidSession = true;
                return; // 提前返回，不需要繼續檢查其他參數
            } else if (sessionError) {
                console.warn('⚠️ 調試點 4: getSessionFromUrl 失敗');
                console.error('錯誤詳情:', sessionError);
                // 繼續嘗試其他方法
            } else {
                console.warn('⚠️ 調試點 5: getSessionFromUrl 沒有返回 session 也沒有錯誤');
            }
        } catch (err) {
            console.warn('❌ 調試點 6: getSessionFromUrl 拋出異常');
            console.error('異常詳情:', err);
            // 繼續嘗試其他方法
        }
        
        // 從 URL fragment (#) 或 query string (?) 獲取參數
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // 檢查兩種格式
        let access_token = urlParams.get('access_token') || hashParams.get('access_token');
        let refresh_token = urlParams.get('refresh_token') || hashParams.get('refresh_token');
        let type = urlParams.get('type') || hashParams.get('type') || hashParams.get('type');
        let code = urlParams.get('code'); // code 通常在 query string 中
        let email = urlParams.get('email'); // 獲取 email 參數
        
        // 如果是從 Supabase 重定向過來的，可能會有 token_hash 在 fragment 中
        let token_hash = hashParams.get('token_hash');
        let error = urlParams.get('error') || hashParams.get('error');
        let error_description = urlParams.get('error_description') || hashParams.get('error_description');
        let error_code = urlParams.get('error_code') || hashParams.get('error_code');
        
        console.log('完整 URL:', window.location.href);
        console.log('Query 參數:', Object.fromEntries(urlParams));
        console.log('Hash 參數:', Object.fromEntries(hashParams));
        console.log('Hash 原始值:', window.location.hash);
        console.log('Access Token:', access_token);
        console.log('Refresh Token:', refresh_token);
        console.log('Type:', type);
        console.log('Code:', code);
        console.log('Email:', email);
        console.log('Token Hash:', token_hash);
        console.log('Error:', error);
        console.log('Error Description:', error_description);
        
        // 暫時允許任何有參數的連結，方便調試
        console.warn('🔍 調試點 7: 檢查 URL 參數');
        
        // 檢查是否有錯誤
        if (error) {
            console.warn('❌ 調試點 8: URL 中有錯誤參數');
            console.log('錯誤:', error, error_description);
            document.getElementById('error').textContent = error_description || error || '發生錯誤，請重試';
            document.getElementById('resetForm').style.display = 'none';
            return;
        }
        
        // Supabase 重設密碼後會在 fragment 中返回 access_token
        if (access_token) {
            console.warn('✅ 調試點 9: 找到 access_token');
            console.log('Access Token:', access_token);
            // 設置 session，這樣用戶就可以更新密碼了
            await supabaseClient.auth.setSession({
                access_token: access_token,
                refresh_token: refresh_token
            });
            
            // 顯示重設密碼表單
            document.getElementById('error').textContent = '';
            document.getElementById('resetForm').style.display = 'block';
            
            // 不需要 code 和 email，因為已經有 session 了
            window.hasValidSession = true;
        } else if (token_hash) {
            console.warn('✅ 調試點 10: 找到 token_hash');
            console.log('Token Hash:', token_hash);
            // 使用 token_hash 驗證
            try {
                const { data, error } = await supabaseClient.auth.verifyOtp({
                    token_hash: token_hash,
                    type: 'recovery'
                });
                
                if (error) {
                    console.error('Token hash 驗證失敗:', error);
                    document.getElementById('error').textContent = '重設連結無效或已過期';
                    document.getElementById('resetForm').style.display = 'none';
                } else {
                    console.log('Token hash 驗證成功:', data);
                    document.getElementById('error').textContent = '';
                    document.getElementById('resetForm').style.display = 'block';
                    window.hasValidSession = true;
                }
            } catch (err) {
                console.error('驗證錯誤:', err);
                document.getElementById('error').textContent = '驗證失敗，請重試';
                document.getElementById('resetForm').style.display = 'none';
            }
        } else if (code) {
            console.warn('🔍 調試點 11: 找到 code 參數');
            console.log('Code:', code);
            console.log('Email:', email);
            
            // 檢查是否有 email 參數
            if (!email) {
                console.warn('❌ 調試點 12: 缺少 email 參數');
                document.getElementById('error').textContent = '重設連結無效：缺少必要的參數';
                document.getElementById('resetForm').style.display = 'none';
                return;
            }
            
            console.warn('🔍 調試點 13: 準備使用 code + email 方式');
            
            // 測試：先試試直接顯示表單，不驗證
            console.warn('🔍 調試點 13.5: 跳過驗證，直接顯示表單（測試）');
            
            // 直接顯示表單，讓用戶輸入新密碼
            // code 和 email 會在提交表單時使用
            document.getElementById('error').textContent = '';
            document.getElementById('resetForm').style.display = 'block';
            
            // 將 code 和 email 存储到全域變數供表單使用
            window.resetPasswordCode = code;
            window.resetPasswordEmail = decodeURIComponent(email);
            window.useAlternativeMethod = true; // 標記使用替代方法
        } else {
            console.log('❌ 沒有找到任何有效參數');
            console.log('完整 URL:', window.location.href);
            document.getElementById('error').textContent = '無效的重設連結：沒有找到 access_token 或 code';
            document.getElementById('resetForm').style.display = 'none';
        }
        
        })(); // 執行初始化函數
        
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            const loadingDiv = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');
            
            // 清除之前的訊息
            errorDiv.textContent = '';
            successDiv.textContent = '';
            
            // 驗證密碼
            if (password !== confirmPassword) {
                errorDiv.textContent = '兩次輸入的密碼不一致';
                return;
            }
            
            if (password.length < 8) {
                errorDiv.textContent = '密碼至少需要 8 個字符';
                return;
            }
            
            if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
                errorDiv.textContent = '密碼必須包含字母和數字';
                return;
            }
            
            // 顯示載入狀態
            loadingDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                // 檢查是否已經有有效的 session（從 access_token 或 token_hash 驗證而來）
                if (window.hasValidSession) {
                    console.warn('🔍 調試點 14: 使用已驗證的 session 更新密碼');
                    
                    const { data: updateData, error: updateError } = await supabaseClient.auth.updateUser({
                        password: password
                    });
                    
                    if (updateError) {
                        console.error('更新密碼失敗:', updateError);
                        errorDiv.textContent = updateError.message || '密碼更新失敗，請稍後再試';
                        return;
                    }
                    
                    console.log('密碼更新成功:', updateData);
                    successDiv.textContent = '密碼重設成功！請回到應用程式登入。';
                    document.getElementById('resetForm').style.display = 'none';
                    
                    // 清除 session，讓用戶重新登入
                    await supabaseClient.auth.signOut();
                } else if (window.useAlternativeMethod && window.resetPasswordCode && window.resetPasswordEmail) {
                    console.warn('🔍 調試點 15: 使用替代方法 - 一次性更新密碼');
                    console.log('Email:', window.resetPasswordEmail);
                    console.log('Code:', window.resetPasswordCode);
                    
                    // 嘗試直接使用 code 作為一次性 token
                    console.warn('🔍 調試點 16: 嘗試直接 API 呼叫');
                    
                    try {
                        const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY
                            },
                            body: JSON.stringify({
                                email: window.resetPasswordEmail,
                                password: password,
                                nonce: window.resetPasswordCode // 嘗試使用 code 作為 nonce
                            })
                        });
                        
                        console.log('API 響應狀態:', response.status);
                        const result = await response.json();
                        console.log('API 響應內容:', result);
                        
                        if (!response.ok) {
                            throw new Error(result.msg || result.message || '更新失敗');
                        }
                        
                        console.warn('✅ 調試點 17: 密碼更新成功');
                        successDiv.textContent = '密碼重設成功！請回到應用程式登入。';
                        document.getElementById('resetForm').style.display = 'none';
                    } catch (apiError) {
                        console.warn('❌ 調試點 18: API 呼叫失敗，嘗試 verifyOtp');
                        console.error('API 錯誤:', apiError);
                        
                        // 回退到 verifyOtp 方法
                        console.warn('🔍 調試點 19: 回退到 verifyOtp');
                        const { data: verifyData, error: verifyError } = await supabaseClient.auth.verifyOtp({
                            email: window.resetPasswordEmail,
                            token: window.resetPasswordCode,
                            type: 'recovery'
                        });
                        
                        console.log('verifyOtp 結果:', { verifyData, verifyError });
                        
                        if (verifyError) {
                            console.warn('❌ 調試點 20: verifyOtp 也失敗了');
                            console.error('錯誤詳情:', verifyError);
                            errorDiv.textContent = verifyError.message || '無效的重設連結或已過期，請重新申請';
                            return;
                        }
                        
                        console.warn('✅ 調試點 21: verifyOtp 成功，現在更新密碼');
                    
                    console.log('代碼驗證成功:', verifyData);
                    
                    // 驗證成功後更新密碼
                    const { data: updateData, error: updateError } = await supabaseClient.auth.updateUser({
                        password: password
                    });
                    
                    if (updateError) {
                        console.error('更新密碼失敗:', updateError);
                        errorDiv.textContent = updateError.message || '密碼更新失敗，請稍後再試';
                        return;
                    }
                    
                    console.log('密碼更新成功:', updateData);
                    successDiv.textContent = '密碼重設成功！請回到應用程式登入。';
                    document.getElementById('resetForm').style.display = 'none';
                    
                    await supabaseClient.auth.signOut();
                } else {
                    errorDiv.textContent = '無效的重設連結，請重新申請';
                    return;
                }
            } catch (error) {
                console.error('重設密碼錯誤:', error);
                errorDiv.textContent = '網路錯誤，請稍後再試';
            } finally {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>